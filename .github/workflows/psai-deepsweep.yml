name: PSAI Deep Sweep
on:
  schedule:
    - cron: '0 11 * * 0'  # 07:00 ET Sundays
  workflow_dispatch:
permissions:
  contents: write
  issues: write
jobs:
  deep:
    runs-on: ubuntu-latest
    env:
      PSAI_DEEP: "1"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML beautifulsoup4 feedgen requests
      - name: Deep discovery
        env:
          PSAI_DEEP: "1"
        run: |
          python scripts/discover.py
          python scripts/merge_candidates.py
      - name: Generate sources
        run: python scripts/generate_sources.py
      - name: Harvest â†’ Log (30d)
        run: python scripts/harvest.py --sources data/sources.yaml --tracker data/PSAI_FullField_Tracker.csv --log data/news_log.json
      - name: Update tracker status
        run: python scripts/update_tracker.py --tracker data/PSAI_FullField_Tracker.csv --log data/news_log.json --out data/PSAI_FullField_Tracker.csv
      - name: Build feeds
        env:
          SITE_URL: ${{ vars.SITE_URL }}
        run: |
          python scripts/build_feed.py --log data/news_log.json --site "${{ env.SITE_URL || 'https://<your-user>.github.io/<your-repo>' }}" --json public/feed.json --rss public/rss.xml
      - name: Build HTML report
        env:
          SITE_URL: ${{ vars.SITE_URL }}
        run: |
          python scripts/build_site.py
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/*.json data/*.csv data/*.yaml public/*.json public/*.xml public/*.html || true
          if git commit -m "PSAI: weekly deep sweep + HTML $(date -u +'%Y-%m-%dT%H:%M:%SZ')"; then
            git push
          else
            echo "Nothing to commit."
          fi
